# =============================================================================
#  Lighttpd Template Configuration – Clean & Modernized
#  (reverse-proxy focused + basic static/auth support)
# =============================================================================

# -------------------------------
#  Core Modules
# -------------------------------
server.modules += (
    "mod_setenv",
    "mod_indexfile",
    "mod_extforward",
    "mod_access",
    "mod_alias",
    "mod_redirect",
    "mod_auth",
    "mod_authn_file",
    "mod_rewrite",
    "mod_magnet",
    "mod_dirlisting",     # optional – enable only if needed
    "mod_staticfile",
    #"mod_status",        # uncomment only when you really need /server-status
)

# -------------------------------
#  Global Server Settings
# -------------------------------
server.document-root    = "/var/www/"
server.port             = 80
server.bind             = "0.0.0.0"   # explicit is clearer (add [::] if needed)

server.username         = "www-data"
server.groupname        = "www-data"
server.pid-file         = "/run/lighttpd.pid"
server.errorlog         = "/var/log/lighttpd/error.log"

server.tag              = "Webserver"
server.upload-dirs      = ( "/var/cache/lighttpd/uploads" )

server.use-noatime      = "enable"
server.stream-response-body = 1

# -------------------------------
#  Connection & Keep-Alive Timeouts
# -------------------------------
server.max-read-idle       = 15     # drop if client stops sending (seconds)
server.max-write-idle      = 30     # drop if client stops receiving
server.max-keep-alive-idle = 5      # shorter keep-alive timeout

# -------------------------------
#  HTTP/2 & Feature Flags
# -------------------------------
server.feature-flags += (
    "server.h2proto"                  => "enable",
    "server.h2c"                      => "enable",
    "server.graceful-shutdown-timeout"=> 5,
    #"server.graceful-restart-bg"     => "enable",  # only if you use it
)

# -------------------------------
#  Strict & Secure URL Parsing (highly recommended)
#  https://redmine.lighttpd.net/projects/lighttpd/wiki/Server_http-parseoptsDetails
# -------------------------------
server.http-parseopts = (
    "header-strict"             => "enable",
    "host-strict"               => "enable",
    "host-normalize"            => "enable",
    "url-normalize-unreserved"  => "enable",
    "url-normalize-required"    => "enable",
    "url-ctrls-reject"          => "enable",
    "url-path-2f-decode"        => "enable",     # change to "disable" only if app breaks
    "url-path-dotseg-remove"    => "enable",     # change to "reject" if preferred
)

# -------------------------------
#  Index & Denied Files
# -------------------------------
index-file.names = ( "index.php", "index.html", "/index.html" )

url.access-deny = ( "~", ".inc" )   # merged your files.publii.json rule here

$HTTP["url"] =~ "\.(it|env|htaccess)$" {
    url.access-deny = ( "" )
}

# Redirect root /files.publii.json → /
$HTTP["url"] == "/files.publii.json" {
    url.redirect     = ( "" => "/" )
    url.redirect-code = 301
}

# -------------------------------
#  Reverse Proxy Setup
# -------------------------------
proxy.server = ( "" => ( ( "host" => "10.150.16.254", "port" => 443 ) ) )

extforward.headers  = ( "X-Forwarded-For" )
extforward.forwarder = (
    "192.168.1.1"   => "trust",
    "10.0.0.1"      => "trust",
    "127.0.0.1"     => "trust",
    "::1"           => "trust"
)

# -------------------------------
#  Basic Authentication (example – /directory/)
# -------------------------------
# auth.backend = "plain"
# auth.backend.plain.userfile = "/etc/lighttpd/users.txt"
#
# auth.require = (
#     "/SomeDirectory/" => (
#         "method"  => "basic",
#         "realm"   => "Password protected area",
#         "require" => "user=yourname"
#     )
# )

# -------------------------------
#  Internal network debug / status
# -------------------------------
$HTTP["remoteip"] == "192.168.1.0/24" {
    setenv.add-response-header = ( "X-Debug-Origin" => "Internal-Node-Verified" )
    # status.status-url = "/server-status"   # enable only when debugging
}

# -------------------------------
#  Directory / Trailing-slash handling (via Lua)
# -------------------------------
magnet.attract-physical-path-to = ( "/etc/lighttpd/redirect.lua" )

# -------------------------------
#  Includes (keep these last)
# -------------------------------
include_shell "/usr/share/lighttpd/use-ipv6.pl " + server.port
include_shell "/usr/share/lighttpd/create-mime.conf.pl"
include "/etc/lighttpd/conf-enabled/*.conf"
